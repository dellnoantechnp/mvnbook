本章开始，引入一个较为真实的背景案例，是后续几个章节的背景。

# 1. 简单的账户注册流程
1. 提供一个未被使用的账号ID
2. 提供一个未被使用的 email 地址
3. 提供一个任意的显示名称
4. 设置安全密码，并重复输入以确认
5. 输入验证码
6. 前往邮箱查收激活连接并点击激活账户
7. 登陆

账户的ID和email地址可以用来唯一地标识某个账户，而显示名称则用来显示在页面上，方便浏览。 

注册的时候还需要输入两次密码，以确保没有输错。 系统则需要负责检查ID和email的唯一性，验证两次输入的密码是否一致。 验证码是由系统随机生成的只能由肉眼识别其内容的图片，可以有效放置机器恶意批量注册，若输入正确的验证码信息，系统则会进行检查，如果验证码错误，系统会生成并返回新的验证码。

一旦所有检查都没问题了，系统就会生成一个激活连接，并发送到用户的邮箱中。点击激活链接后，账户就会被激活，这时账户注册完毕，用户可以进行登陆。

对于一个账户注册服务，还需要考虑一些安全因素。 例如，需要在服务器端密文的保存密码，检查密码的复杂性，更进一步则需要考虑验证码的有效时间，激活链接的有效时间，等等。

本章的主要目的是让读者清楚的了解这个背景案例，即账户注册服务，它的需求是什么，基于这样的一个需求，我们会怎样设计一个小型的系统。

本章几乎不会涉及 Maven，但后面的章节讲述各种 Maven 概念和实践的时候，都会基于这一实际的背景案例。

# 2. 需求阐述
了解账户注册服务之后，下面从软件工程的视图来分下一下该服务的需求。

## 2.1 需求用例

---
**注册账户：**

主要场景：

1. 用户访问注册页面
2. 系统生成验证码图片
3. 用户输入想要的ID、Email地址，想要的显示名称、密码、确认密码
4. 用户输入验证码
5. 用户提交注册请求
6. 系统检查验证码
7. 系统检查ID是否已经被注册，Email是否已经被注册，密码和确认密码是否一致
8. 系统保存未激活的账户信息
9. 系统生成激活链接，并发送至用户邮箱
10. 用户打开邮箱，访问激活链接
11. 系统解析激活链接，激活相关账户
12. 用户使用ID和密码登陆


*扩展场景：*

4a：用户无法看清验证码，请求重新生成
  1. 跳转到步骤2
  
6a：系统检测到用户输入的验证码错误
  1. 系统提示验证码错误
  2. 跳转到步骤2
  
7a：系统检测到ID已被注册，或者Email已被注册，或者密码和确认密码不一致
  1. 系统提示相关错误信息
  2. 跳转到步骤2
  
---
该注册账户用例包含了一个主要场景和几个扩展场景。 该用例的角色只有两个：用户和系统。

“主要场景”描述了用户如何与系统一步一步地交互，并且成功完成注册。

“扩展场景”则描述了一些中途发生意外的情形，比如用户输入验证码错误，系统就需要重新生成新的验证码，用户也需要重新输入验证码。

该用例倒没有设计非功能性需求，也没有详细定义用户界面，用例也不会告诉我们使用何种技术。关于该服务的安全性，你将会看到一些实际的措施，但我们不会过于深入；关于用户界面，下一小节会给出一个界面圆形；置于使用的技术，该项目会基于大家所熟知的 **Spring** 进一步开发。

## 2.2 界面原型
![1.png](https://github.com/dellnoantechnp/mvnbook/blob/main/Chapter4/.pic/1.png)

# 3. 简要设计
## 3.1 接口
从需求用例中可以看到，系统对外的接口包括生成验证码图片、处理注册请求、激活账户以及处理登陆等。

![2.png](https://github.com/dellnoantechnp/mvnbook/blob/main/Chapter4/.pic/2.png)

首先需要解释的是`generateCaptchaKey()`和`generateCaptchaImage()`方法，对于`Captcha`的简单解释就是验证码。 每个`Captcha`都需要有一个key，根据这个key，系统才能得到对应的验证码图片以及实际值。 因此，`generateCaptchaKey()`会生成一个`Captcha key`，使用这个 key 再调用`generateImage()`方法就能得到验证码图片。 验证码的key以及验证码图片被传送到客户端，用户通过肉眼识别再输入验证码的值，伴随着key再传送到服务器端验证，服务器端就可以通过这个key查到正确的验证码值，并与客户端传过来的值进行对比验证。

`SignUpRequest`包含了注册用户所需要的信息，包括ID，email，显示名称，密码，确认密码等。 这些信息伴随着`Captcha key`和`Catcha value`构成了一个注册请求，`signUp()` 方法接收`SignUpRequest`对象，进行验证，如果验证码正确，则创建一个未被激活的账户，同时在后台也需要发哦送你个一封带有激活链接的邮件。

`activate()` 方法接受一个激活码，查找对应的账户进行激活。

账户激活之后，用户可以使用`login()` 方法进行登陆。

## 3.2 模块结构
定义了系统核心的几口之后，基于功能分割的方便复用的原则，再对系统进一步进行花粉。这里基于包名划分模块，这也是在 Java 中比较常见的做法。
![3.png](https://github.com/dellnoantechnp/mvnbook/blob/main/Chapter4/.pic/3.png)

现在逐个解释一下各个模块(包)的作用：

* `com.juvenxu.mvnbook.account.service`：系统的核心，它封装了所有下层细节，对外暴露简单的几口。 这实际上是一个`Facede`模式，了解设计模式的读者应该能马上理解。
* `com.juvenxu.mvnbook.account.web`：顾名思义，该模块包含所有与`web`相关的内容，包括可能的 JSP、Servlet、web.xml 等，它直接依赖于`com.juvenxu.mvnbook.account.service` 模块，使用其提供的服务。
* `com.juvenxu.mvnbook.account.persist`：处理账户信息的持久化，包括增、删、改、查等，根据实现，可以基于数据库或者文件。
* `com.juvenxu.mvnbook.account.captcha`：处理验证码的 key 生成、图片生成以及验证等，这里需要第三方的类库来帮助实现这些功能。
* `com.juvenxu.mvnbook.account.email`：处理邮件服务的配置、激活邮件的编写和发送等工作。

# 4. 小结
到目前为止，我们已经了解了账户注册服务的需求。大概的界面、简单的接口设计以及模块的职责划分。

